---
apiVersion: v1
kind: Pod
metadata:
  name: daguploader
spec:
  serviceAccountName: airflow-worker
  # initContainers:
  #   - name: init-container
  #     image: "python:3.6"
  #     command: ["python", "-c"]
  #     args: ["import time;time.sleep(300);print('hello world');"]
  #     resources:
  #       limits:
  #         cpu: 500m
  #         memory: 1Gi
  #       requests:
  #         cpu: 500m
  #         memory: 1Gi
  # serviceAccount:
  #   # Specifies whether a ServiceAccount should be created
  #   create: true
  #   # The name of the ServiceAccount to use.
  #   # If not set and create is true, a name is generated using the release name
  #   name: ~

  #   # Annotations to add to worker kubernetes service account.
  #   #annotations: {}
  #   annotations:
  #     eks.amazonaws.com/role-arn: arn:aws-cn:iam::662914226203:role/qa/WishPost_QA
  #     eks.amazonaws.com/audience: sts.amazonaws.com.cn

  containers:
    - name: base
      command: ["python", "-c"]
      args: ["import time;time.sleep(300);print('hello world');"]
      image: "harbor.infra.wish-cn.com/wish/wishpost-airflow@sha256:089400dea49a5f7935fd42e240483ccb2f722c4fd48d6f41a8c566280d725ba4"
      imagePullPolicy: IfNotPresent
      ports: []
      resources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 500m
          memory: 1Gi
         
      volumeMounts:
        - name: credential
          mountPath: '/opt/vault/secrets'
          readOnly: true
      env:
        - name: DB_SECRETS_FILE
          value: '/opt/vault/secrets/db_credentials'
        - name: AIRFLOW__SMTP__SMTP_HOST
          value: 'smtp.sendgrid.net'
        - name: AIRFLOW__SMTP__SMTP_STARTTLS
          value: 'True'
        - name: AIRFLOW__SMTP__SMTP_SSL
          value: 'False'
        - name: AIRFLOW__SMTP__SMTP_USER
          value: 'apikey'
        - name: AIRFLOW__CORE__default_task_execution_timeout
          value: '3600'
        - name: AIRFLOW__SMTP__SMTP_MAIL_FROM
          value: 'airflow-notifications@wish.com'  
        - name: AIRFLOW__SMTP__SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: wishflow-wishpost-credential
              key: sendgrid_password
        
      # volumeMounts:
      #   - name: shared-volume
      #     mountPath: "/tmp/mnt"
  #hostNetwork: false
  restartPolicy: Never
  volumes:
    - name: credential
      secret:
        secretName: wishflow-wishpost-credential
  # volumes:
  # - name: shared-volume
  #   emptyDir: {}